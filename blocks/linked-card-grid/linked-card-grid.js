import { domEl } from '../../scripts/dom-helpers.js';
import { getIndividualIcon } from '../../scripts/utils.js';

/**
* Generates a the content in the card.
* @param {HTMLElement} div - The `div` element to be transformed into a card media section.
* @param {HTMLElement} container - The card wrapper the content should be in.
*/
function generateContent( div, container ) {
	const wrap = div.querySelector( 'p:has(a)' ); //
	wrap.className = 'usa-button__wrap';
	const a = wrap.querySelector( 'a' ) ? wrap.querySelector( 'a' ) : null;
	const heading = div.querySelector( 'h2, h3, h4, h5, h6' );
	const img = container.querySelector( 'picture' );	
	let header = '';
	div.className = 'usa-card__body';

	

	if ( img ){
		img.className = 'usa-card__img';
	}
	// take out the heading and put into its own container
	if ( heading ) {
		heading.classList.add( 'usa-card__heading' );
		header = domEl( 'div', { class: 'usa-card__header' }, heading );
		container.prepend( header );
		
		// Wrap the link in the header 
		if ( a ) {
			a.textContent = ''; 
			a.className = '';
			heading.append( a );
			getIndividualIcon( wrap, 'arrow_forward' );
		} 
	}
	else {
		if ( wrap ) {
			wrap.remove();
			// eslint-disable-next-line no-console
			console.error( 'No heading provided. Please re-author with the appropriate heading' );
		}
	}
}

/**
* Generates in the card.
* @param {HTMLElement} container - The card wrapper the content should be in. child of the li
*/
function generateWholeCard( container ) {
	[...container.children].forEach( ( div ) => {
		generateContent( div, container );
	} );
}

/**
* Generates all content in the card
* @param {HTMLElement} block - The card grid generated by EDS
*/
export default function decorate( block ) {
	let grid =  'grid-col-12 tablet:grid-col-6 desktop:grid-col-4';
	
	const parent = block.parentElement
	const layout = parent?.parentElement?.dataset?.layout;

	if(layout){

		const colClass = [...parent.classList].find(c => c.startsWith('desktop:grid-col-'));

		if (colClass) {
    		const value = parseInt(colClass.replace('desktop:grid-col-', ''), 10);
    		grid = value > 6
      		? 'grid-col-12 tablet:grid-col-6 desktop:grid-col-6'
      		: 'grid-col-12 tablet:grid-col-6 desktop:grid-col-12';
		}
	}
	
	
	const ul = domEl( 'ul', { class: 'usa-card-group grid-row' } );

	[...block.children].forEach( ( row ) => {
		const li = domEl( 'li', { class: `usa-card ${grid}` } );
		const cardContainer = domEl( 'div', { class: 'usa-card__container' } );

		// add all the table row contents into a li with a container wrapper inside
		while ( row.firstElementChild ) {
			cardContainer.append( row.firstElementChild );
			li.append( cardContainer );
		}
		
		generateWholeCard( cardContainer );
		ul.append( li );
	} );

	block.textContent = '';
	block.append( ul );
}
